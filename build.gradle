plugins {
    alias(libs.plugins.preprocessor)
    alias(libs.plugins.grgit)
}

preprocess {
    strictExtraMappings = false

    def mc12111 = createNode("1.21.11", 1_21_11, "mojang")

    mc12111.link(mc12111, null)
}

def ENV = System.getenv()
String realVersion = "${project.mod_version}+build."
realVersion += ENV.GITHUB_RUN_NUMBER ? ENV.GITHUB_RUN_NUMBER : new Date().format("yyyyMMdd.HHmmss")
if (grgit != null) {
    realVersion += grgit.status().isClean() ? "+${grgit.head().abbreviatedId}" : "+uncommited"
} else {
    realVersion += "+nogit"
}

version = realVersion

tasks.register("cleanPreprocessSources") {
    doFirst {
        subprojects {
            layout.buildDirectory.dir("preprocessed").getOrNull().asFile.deleteDir()
        }
    }
}
